@inject StateContainer stateContainer

@if (fnID == stateContainer.selectedFn)
{
    foreach (Coupling couplingS in stateContainer.couplingList.FindAll(x => x.outputFn == fnID || x.toFn == fnID))
    {
        <path fill="none" stroke-width="5" stroke="#4444DD" stroke-linecap="round" opacity="0.5" d=@reDrawLines(couplingS.Name) />
        couplingS.resetPosition();
        <g transform="scale(@(stateContainer.tempZoomA))" display="@stateContainer.AspectLabelsDisplay">
            <rect x=@(couplingS.labelX - couplingS.Twidth / 2) y=@couplingS.labelY width=@couplingS.Twidth height=@(Math.Min(5 + couplingS.displayText.Count * 8, 50)) style="fill: #FFFFFF; stroke: none; opacity: 0.6" rx="5" ry="5" />
            <text transform="translate(0,-2)" x=@couplingS.labelX y=@(couplingS.labelY + 3) font-size="5pt" text-anchor="middle" font-family="'PT Sans Caption', sans-serif">
                @for (int i = 0; i < couplingS.displayText.Count; i++)
                {
                    <tspan x=@couplingS.labelX dy="8">@couplingS.displayText[i]</tspan>
                }
            </text>
        </g>
    }
}
<g class=@fnClass transform="translate(@fn.Attributes["x"].Value,@fn.Attributes["y"].Value)"
   @onmousedown="SelectFn" @ontouchstart="SelectFnTouch" @onmousemove="MoveFn" @ontouchmove="MoveFnTouch" @onmouseup="MoveFnStop" @ontouchend="MoveFnStopTouch">
@if (fnID == stateContainer.selectedFn)
    {
        if (stateContainer.dragFn)
        {
            <circle cx="50" cy="50" fill="white" opacity="0" r="100%" />
        }
        <circle cx="50" cy="50" r="60" fill="url(#4444DD)" />
    //} else if (selectedGroup[0]==sFn) { //set background highlight colour
    // svgXML.g.(@id==sFn).appendChild(<circle cx="50" cy="50" r="60" fill="url(#00F2FF)" />);
    //} else if (checkGroup.indexOf("|"+sFn+"|")>-1){
    // svgXML.g.(@id==sFn).appendChild(<circle cx="50" cy="50" r="60" fill="url(#11FF55)" />);
    //} else if (functionArray[sFn].HLColor!=null) {
    //   svgText = "url(#" + functionArray[sFn].HLColor + ")";
    //   svgXML.g.(@id==sFn).appendChild(<circle cx="50" cy="50" r="60" fill={svgText} />);
}
@if (orphans > 0)
{
    if (((orphans >> 0) & 1) == 1) //Input
    {
        <circle stroke-width="5" stroke="#FF0000" fill="none" opacity="0.7" cx="6" cy="50" r="7" />
    }
    if (((orphans >> 1) & 1) == 1) //Output
    {
        <circle stroke-width="5" stroke="#FF0000" fill="none" opacity="0.7" cx="93.5" cy="50" r="7" />
    }
    if (((orphans >> 2) & 1) == 1) //Precondition
    {
        <circle stroke-width="5" stroke="#FF0000" fill="none" opacity="0.7" cx="28" cy="88" r="7" />
    }
    if (((orphans >> 3) & 1) == 1) //Resource
    {
        <circle stroke-width="5" stroke="#FF0000" fill="none" opacity="0.7" cx="71.5" cy="88" r="7" />
    }
    if (((orphans >> 4) & 1) == 1) //Control
    {
        <circle stroke-width="5" stroke="#FF0000" fill="none" opacity="0.7" cx="71.5" cy="12" r="7" />
    }
    if (((orphans >> 5) & 1) == 1) //Time
    {
        <circle stroke-width="5" stroke="#FF0000" fill="none" opacity="0.7" cx="28" cy="12" r="7" />
    }
}
@if (fnStyle != "1") //traditional or floating
{
    <g stroke-width="1" stroke="#555555">
        @if (fnStyle == "0") //traditional, not floating
        {
            <path d="M 6 50 L 93.5 50 M 28 12 L 71.5 88 M 71.5 12 L 28 88" />
        }
        @if (FunctionType == "2") //background
        {
            <path fill="#EEEEEE" d="M 14 50 L 32 18.8 L 67.5 18.8 L 85.5 50 L 67.5 81.1 L 32 81.1 L 14 50 Z" />
        }
        else  //foreground
        {
            <path fill="#FFFFFF" d="M 14 50 L 32 18.8 L 67.5 18.8 L 85.5 50 L 67.5 81.1 L 32 81.1 L 14 50 Z" />
        }
    </g>
}
else if (fnStyle == "1" && FunctionType != "2") //modern and foreground
{
    <g stroke-width="1" stroke="#555555">
        <path fill="#FAFAFA" d="M 6 50 L 28 12 L 71.5 12 L 93.5 50 L 71.5 88 L 28 88 L 6 50 Z" />
    </g>
}
@if (fnStyle != "1" || FunctionType != "2") //not modern or not background (same as not both modern and background)
{
    @if (fnStyle == "2") //Floating
    {
        <g stroke-width="1" stroke="#999999">
            <circle cx="6" cy="50" r="5" fill="white" />
            <circle cx="93.5" cy="50" r="5" fill="white" />
            <circle cx="28" cy="12" r="5" fill="white" />
            <circle cx="71.5" cy="12" r="5" fill="white" />
            <circle cx="28" cy="88" r="5" fill="white" />
            <circle cx="71.5" cy="88" r="5" fill="white" />
        </g>
    }
    else //not Floating
    {
        <g stroke-width="1" stroke="#555555">
            <circle cx="6" cy="50" r="5" fill="white" />
            <circle cx="93.5" cy="50" r="5" fill="white" />
            <circle cx="28" cy="12" r="5" fill="white" />
            <circle cx="71.5" cy="12" r="5" fill="white" />
            <circle cx="28" cy="88" r="5" fill="white" />
            <circle cx="71.5" cy="88" r="5" fill="white" />
        </g>
    }
}
@if (FunctionType == "1") //variable foreground
{
    <g stroke="#BBBBBB"><path fill="none" d="M 30 50 Q 35 30 40 30 Q 45 30 50 50 Q 55 70 60 70 Q 65 70 70 50" /></g>
}
@if (fnColorStyle != null)
{
    if (fnColorStyle != "white" && fnColorStyle.Length != 0)
    {
        styleStroke = "5";
        switch (fnColorStyle)
        {
            case "blue": styleColor = "#01A6DB"; break;
            case "green": styleColor = "#17BD01"; break;
            case "grey": styleColor = "#838383"; break;
            case "red": styleColor = "#E50000"; break;
            case "yellow": styleColor = "#BAB727"; break;
            case "purple": styleColor = "#9070C0"; break;
            case "white": styleColor = "#FFFFFF"; break;
            case "custom": styleColor = "#" + "000000".Substring(Convert.ToUInt32(fnColorValue).ToString("X").Length) + Convert.ToUInt32(fnColorValue).ToString("X"); break;
            default: styleColor = "#555555"; styleStroke = "1"; break;
        }
        if (fnStyle != "1") //not Modern
        {
            <g>
                <g stroke-width="5" stroke=@styleColor><path fill="none" d="M 16.3 50 L 33.2 21 L 66.3 21 L 83.2 50 L 66.3 79 L 33.2 79 L 16.3 50 Z" /></g>
                <g stroke-width="1" stroke="#555555"><path fill="none" d="M 14 50 L 32 18.8 L 67.5 18.8 L 85.5 50 L 67.5 81.1 L 32 81.1 L 14 50 Z" /></g>
            </g>
        }
        else if (fnStyle == "1" && FunctionType != "2") //Modern and not background
        {
            <g>
                <g stroke-width="5" stroke=@styleColor><path fill="none" d="M 8.3 50 L 29.2 14.2 L 70.3 14.2 L 91.2 50 L 70.3 85.9 L 29.2 85.9 L 8.3 50 Z" /></g>
            </g>
            <g stroke-width="1" stroke="#555555"><path fill="none" d="M 6 50 L 28 12 L 71.5 12 L 93.5 50 L 71.5 88 L 28 88 L 6 50 Z" /></g>
            <g stroke-width="1" stroke="#555555">
                <circle cx="6" cy="50" r="5" fill="white" />
                <circle cx="93.5" cy="50" r="5" fill="white" />
                <circle cx="28" cy="12" r="5" fill="white" />
                <circle cx="71.5" cy="12" r="5" fill="white" />
                <circle cx="28" cy="88" r="5" fill="white" />
                <circle cx="71.5" cy="88" r="5" fill="white" />
            </g>
        }
    }
    else
    {
        styleStroke = "1";
        styleColor = "#999999";
    }
}
else
{
    styleStroke = "1";
    styleColor = "#999999";
}
@if (fnStyle == "1" && FunctionType == "2") //modern background
{
    if (isInput == "true")
    {
        <g stroke-width=@styleStroke stroke=@styleColor><circle cx="6" cy="50" r="5" fill="white" /></g>
    }
    else
    {
        <g stroke-width=@styleStroke stroke=@styleColor><circle cx="93.5" cy="50" r="5" fill="white" /></g>
    }

    <rect transform="scale(@stateContainer.tempZoomF)" x="@(50 / stateContainer.tempZoomF - 36)" y="@(50 / stateContainer.tempZoomF - lineCount * 5 - 5)" rx="5" ry="5" width="71" height="@(9 + lineCount * 10)" style="fill:#EEEEEE;stroke:none;opacity:1" />
}
@if (fnStyle != "1" || FunctionType != "2")
{
    <g font-size="6pt" font-family="'PT Sans Caption', sans-serif">
        <text x="25.4" y="14.8">T</text>
        <text x="68.4" y="14.8">C</text>
        <text x="4.2" y="52.8">I</text>
        <text x="90.4" y="52.8">O</text>
        <text x="25.6" y="90.8">P</text>
        <text x="68.8" y="90.8">R</text>
    </g>
}
<text transform="scale(@stateContainer.tempZoomF)" x="@(50 / stateContainer.tempZoomF)" y="@(50 / stateContainer.tempZoomF - lineCount * 5 - 3)" font-size="6pt" text-anchor="middle" width="60" height="40" font-family="'PT Sans Caption', sans-serif">
    @for (int i = 0; i < lineCount; i++)
    {
        <tspan x="@(50 / stateContainer.tempZoomF)" dy="10">@displayText[i]</tspan>
    }
</text>
</g>

@code {
    private Dictionary<string, double> posX = new Dictionary<string, double> { { "I", 6 }, { "O", 93.5 }, { "T", 28 }, { "C", 71.5 }, { "P", 28 }, { "R", 71.5 } };
    private Dictionary<string, double> posY = new Dictionary<string, double> { { "I", 50 }, { "O", 50 }, { "T", 12 }, { "C", 12 }, { "P", 88 }, { "R", 88 } };
    private string styleStroke = "1";
    private string styleColor = "#999999";
    private int lineCount;
    private string fnID = "-1";
    private string fnColorValue = "";
    private string fnColorStyle = "";
    private List<string> displayText = new List<string> { "" };
    private string fnStyle = "0";
    private string FunctionType = "0";
    private string isInput = "false";
    private int orphans = 0;
    private bool shouldRender;
    //private bool dragFn = false;
    private bool dragAspect = false;
    //private bool isSelected = false;
    //private double startX;
    //private double startY;
    //private double lastX;
    //private double lastY;
    //private double moveInterval = 0;
    private string fnClass = "fn-hover";
    //private string[]? curve;
    //private int iTo;
    //private bool moveAspects = false;
    //private double moveX = 0;
    //private double moveY = 0;
    //   private double scaleZoom = 1.5;

    //{ selectedFn, tempZoomF.ToString(), previousFn }
    //[CascadingParameter] string[] indexState { get; set; }

    [Parameter]
    public XmlNode? fn { get; set; }
    [Parameter]
    public EventCallback refreshParent { get; set; }

    protected override void OnParametersSet()
    {
        fnID = fn.SelectSingleNode("IDNr").InnerText;
        //fnX = double.Parse(fn.Attributes["x"].Value);
        //fnY = double.Parse(fn.Attributes["y"].Value);
        displayText = returnTextLines(fn.SelectSingleNode("IDName").InnerText, 11);
        lineCount = displayText.Count;
        orphans = Convert.ToInt32(fn.SelectSingleNode("@orphans").Value);
        fnStyle = fn.Attributes["fnStyle"].Value;
        FunctionType = fn.SelectSingleNode("FunctionType").InnerText;
        isInput = fn.SelectSingleNode("@isInput").InnerText;
        fnColorStyle = fn.Attributes["style"]?.Value;
        fnColorValue = fn.Attributes["color"]?.Value;
    }
    //protected override bool ShouldRender() => shouldRender;

    private List<string> returnTextLines(string text, int length)
    {
        var textLines = new List<string>();
        string[] textWords = text.Split(" ");
        int tL = 0;
        textLines.Add("");
        int lL = length;
        foreach (string tWord in textWords)
        {
            if (tWord.Length <= lL)
            {
                if (lL < length)
                {
                    textLines[tL] += " ";
                }
                textLines[tL] += tWord;
                lL -= tWord.Length;
            }
            else if (tWord.Length > length)
            {
                string tempWord = tWord;
                while (tempWord.Length > 0)
                {
                    textLines.Add("");
                    tL++;
                    lL = length;
                    string addWord = tempWord.Substring(0, Math.Min(length + 1, tempWord.Length));
                    textLines[tL] += addWord;
                    lL -= addWord.Length;
                    tempWord = tempWord.Substring(addWord.Length);
                }
            }
            else
            {
                textLines.Add("");
                tL++;
                textLines[tL] += tWord;
                lL = length - tWord.Length;
            }
        }
        return textLines;
    }
    private void SelectFnTouch(TouchEventArgs e)
    {
        if (e.Touches.Length == 1)
        {
            stateContainer.selectedFn = fnID;
            refreshParent.InvokeAsync();
            stateContainer.sFn = stateContainer.projectData_Undo[0].SelectSingleNode("//FM/Functions/Function[IDNr=" + fnID + "]");
            stateContainer.moveX = double.Parse(stateContainer.sFn.Attributes["x"].Value);
            stateContainer.moveY = double.Parse(stateContainer.sFn.Attributes["y"].Value);
            stateContainer.startX = e.Touches[0].ClientX / stateContainer.scaleZoom - stateContainer.moveX;
            stateContainer.startY = e.Touches[0].ClientY / stateContainer.scaleZoom - stateContainer.moveY;
            stateContainer.dragFn = true;
            fnClass = "fn-move";
            // ? touchAction = "touch-stop";
        }
    }
    private void SelectFn(MouseEventArgs e)
    {
        stateContainer.selectedFn = fnID;
        refreshParent.InvokeAsync();
        stateContainer.sFn = stateContainer.projectData_Undo[0].SelectSingleNode("//FM/Functions/Function[IDNr=" + fnID + "]");
        stateContainer.moveX = double.Parse(stateContainer.sFn.Attributes["x"].Value);
        stateContainer.moveY = double.Parse(stateContainer.sFn.Attributes["y"].Value);
        stateContainer.startX = e.ClientX / stateContainer.scaleZoom - stateContainer.moveX;
        stateContainer.startY = e.ClientY / stateContainer.scaleZoom - stateContainer.moveY;
        stateContainer.dragFn = true;
        fnClass = "fn-move";
    }
    private void MoveFnTouch(TouchEventArgs e)
    {
        if (stateContainer.dragFn && e.Touches.Length == 1)
        {
            stateContainer.moveX = (e.Touches[0].ClientX / stateContainer.scaleZoom - stateContainer.startX);
            stateContainer.moveY = (e.Touches[0].ClientY / stateContainer.scaleZoom - stateContainer.startY);
            if (stateContainer.moveX > stateContainer.viewWidth - 120)
            {
                stateContainer.viewWidth += 120;
                stateContainer.canvasWidth = stateContainer.viewWidth * stateContainer.scaleZoom;
                refreshParent.InvokeAsync();
            }
            if (stateContainer.moveY > stateContainer.viewHeight - 120)
            {
                stateContainer.viewHeight += 120;
                stateContainer.canvasHeight = stateContainer.viewHeight * stateContainer.scaleZoom;
                refreshParent.InvokeAsync();
            }
            stateContainer.sFn.Attributes["x"].Value = stateContainer.moveX.ToString("#.##");
            stateContainer.sFn.Attributes["y"].Value = stateContainer.moveY.ToString("#.##");
        }
        else if (dragAspect)
        {

        }
    }
    private void MoveFn(MouseEventArgs e)
    {
        if (stateContainer.dragFn)
        {
            stateContainer.moveX = (e.ClientX / stateContainer.scaleZoom - stateContainer.startX);
            stateContainer.moveY = (e.ClientY / stateContainer.scaleZoom - stateContainer.startY);
            if (stateContainer.moveX > stateContainer.viewWidth - 120)
            {
                stateContainer.viewWidth += 120;
                stateContainer.canvasWidth = stateContainer.viewWidth * stateContainer.scaleZoom;
                refreshParent.InvokeAsync();
            }
            if (stateContainer.moveY > stateContainer.viewHeight - 120)
            {
                stateContainer.viewHeight += 120;
                stateContainer.canvasHeight = stateContainer.viewHeight * stateContainer.scaleZoom;
                refreshParent.InvokeAsync();
            }
            stateContainer.sFn.Attributes["x"].Value = stateContainer.moveX.ToString("#.##");
            stateContainer.sFn.Attributes["y"].Value = stateContainer.moveY.ToString("#.##");
        }
        else if (dragAspect)
        {

        }
    }
    private void MoveFnStopTouch(TouchEventArgs e)
    {
        if (stateContainer.dragFn)
        {
            if (stateContainer.couplingList.Count > 0)
            {
                foreach (Coupling couplingS in stateContainer.couplingList.FindAll(x => x.outputFn == fnID || x.toFn == fnID))
                {
                    stateContainer.projectData_Undo[0].SelectSingleNode("//FM/Aspects/Aspect[Name=\"" + couplingS.Name + "\"]/Curve2").InnerText = reDrawLines(couplingS.Name);
                    stateContainer.projectData_Undo[0].SelectSingleNode("//FM/Aspects/Aspect[Name=\"" + couplingS.Name + "\"]/Curve").InnerText = couplingS.UpdateCurve();
                }
            }
            stateContainer.dragFn = false;
            dragAspect = false;
            fnClass = "fn-hover";
            // ? touchAction = "";
        }
    }
    private void MoveFnStop(MouseEventArgs e)
    {
        if (stateContainer.dragFn)
        {
            if (stateContainer.couplingList.Count > 0)
            {
                foreach (Coupling couplingS in stateContainer.couplingList.FindAll(x => x.outputFn == fnID || x.toFn == fnID))
                {
                    stateContainer.projectData_Undo[0].SelectSingleNode("//FM/Aspects/Aspect[Name=\"" + couplingS.Name + "\"]/Curve2").InnerText = reDrawLines(couplingS.Name);
                    stateContainer.projectData_Undo[0].SelectSingleNode("//FM/Aspects/Aspect[Name=\"" + couplingS.Name + "\"]/Curve").InnerText = couplingS.UpdateCurve();
                }
            }
            stateContainer.dragFn = false;
            dragAspect = false;
            fnClass = "fn-hover";
        }
    }
    private string reDrawLines(string key)
    {
        //this function gets all the line coordinates
        //draws two quadratic Bezier curves to connect an Output with another Aspect
        //draws from {drawFrom} to {drawTo} through intermediate point {drawInt}
        //{drawA} and {drawB} are control points to create the curve. For a smooth curve {drawA}, {drawB} and {drawInt} must all be on the same line
        Coupling getCoupling = stateContainer.couplingList.Find(x => x.Name == key);
        if (getCoupling.outputFn == fnID)
        {
            getCoupling.drawTox = stateContainer.moveX + posX["O"];
            getCoupling.drawToy = stateContainer.moveY + posY["O"];
        } else
        {
            getCoupling.drawFromx = stateContainer.moveX + posX[getCoupling.toType];
            getCoupling.drawFromy = stateContainer.moveY + posY[getCoupling.toType];
        }
        //XmlNode indexSubFn = stateContainer.projectData_Undo[0].SelectSingleNode("//FM/Functions/Function[IDNr=" + getCoupling.toFn + "]");
        if (getCoupling.toType == "I")
        { //does a fn1 Output connect with a fn2 Input
            if (getCoupling.drawFromx > getCoupling.drawTox - 20)
            {
                getCoupling.drawAx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                getCoupling.drawAy = getCoupling.drawFromy;
                getCoupling.drawBx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.75;
                getCoupling.drawBy = getCoupling.drawToy;
            }
            else
            {
                if (Math.Abs(getCoupling.drawToy - getCoupling.drawFromy) > 120)
                {
                    getCoupling.drawAx = getCoupling.drawFromx - 20;
                    getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.375;
                    getCoupling.drawBx = getCoupling.drawTox + 20;
                    getCoupling.drawBy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.625;
                }
                else
                {
                    getCoupling.drawAx = getCoupling.drawFromx - 20;
                    getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                    getCoupling.drawBx = getCoupling.drawTox + 20;
                    getCoupling.drawBy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                }
            }
            getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
            getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
        }
        else if (getCoupling.toType == "T")
        { //does a fn1 output connect with a fn2 Time
            if (getCoupling.drawFromx > getCoupling.drawTox - 10)
            {
                if (getCoupling.drawFromy > getCoupling.drawToy)
                {
                    getCoupling.drawAx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                    getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                    getCoupling.drawBx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.75;
                    getCoupling.drawBy = getCoupling.drawToy;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                    getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.75;
                }
                else
                {
                    getCoupling.drawAx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                    getCoupling.drawAy = getCoupling.drawFromy;
                    getCoupling.drawBx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.75;
                    getCoupling.drawBy = getCoupling.drawToy;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.625;
                    getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                }
            }
            else
            {
                if (getCoupling.drawFromy > getCoupling.drawToy + 40)
                {
                    if (Math.Abs(getCoupling.drawToy - getCoupling.drawFromy) > 120)
                    {
                        getCoupling.drawAx = getCoupling.drawFromx - 20;
                        getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.125;
                        getCoupling.drawBx = getCoupling.drawTox + 20;
                        getCoupling.drawBy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.375;
                        getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                        getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
                    }
                    else
                    {
                        getCoupling.drawAx = getCoupling.drawFromx - 20;
                        getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
                        getCoupling.drawBx = getCoupling.drawTox + 20;
                        getCoupling.drawBy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
                        getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                        getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
                    }
                }
                else
                {
                    getCoupling.drawAx = getCoupling.drawFromx;
                    getCoupling.drawAy = getCoupling.drawFromy - 20;
                    getCoupling.drawBx = getCoupling.drawTox + 20;
                    getCoupling.drawBy = getCoupling.drawFromy - 20;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                    getCoupling.drawInty = getCoupling.drawFromy - 20;
                }
            }
        }
        else if (getCoupling.toType == "C")
        { //does a fn1 output connect with a fn2 Control
            if (getCoupling.drawFromx > getCoupling.drawTox - 10)
            {
                if (getCoupling.drawFromy > getCoupling.drawToy + 20)
                {
                    getCoupling.drawAx = getCoupling.drawFromx;
                    getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                    getCoupling.drawBx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                    getCoupling.drawBy = getCoupling.drawToy;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                    getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.75;
                }
                else
                {
                    getCoupling.drawAx = getCoupling.drawFromx;
                    getCoupling.drawAy = getCoupling.drawFromy - 20;
                    getCoupling.drawBx = getCoupling.drawTox + 20;
                    getCoupling.drawBy = getCoupling.drawFromy - 20;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                    getCoupling.drawInty = getCoupling.drawFromy - 20;
                }
            }
            else
            {
                getCoupling.drawAx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5 + 20;
                getCoupling.drawAy = getCoupling.drawFromy;
                getCoupling.drawBx = getCoupling.drawTox + 20;
                getCoupling.drawBy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.75 + 20;
                getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
            }
        }
        else if (getCoupling.toType == "P")
        { //does a fn1 output connect with a fn2 Precondition
            if (getCoupling.drawFromx > getCoupling.drawTox - 10)
            {
                if (getCoupling.drawFromy > getCoupling.drawToy)
                {
                    getCoupling.drawAx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                    getCoupling.drawAy = getCoupling.drawFromy;
                    getCoupling.drawBx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.75;
                    getCoupling.drawBy = getCoupling.drawToy;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.625;
                    getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                }
                else
                {
                    getCoupling.drawAx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                    getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                    getCoupling.drawBx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.75;
                    getCoupling.drawBy = getCoupling.drawToy;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                    getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.75;
                }
            }
            else
            {
                if (getCoupling.drawFromy > getCoupling.drawToy - 40)
                {
                    getCoupling.drawAx = getCoupling.drawFromx;
                    getCoupling.drawAy = getCoupling.drawFromy + 20;
                    getCoupling.drawBx = getCoupling.drawTox + 20;
                    getCoupling.drawBy = getCoupling.drawFromy + 20;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                    getCoupling.drawInty = getCoupling.drawFromy + 20;
                }
                else
                {
                    if (Math.Abs(getCoupling.drawToy - getCoupling.drawFromy) > 120)
                    {
                        getCoupling.drawAx = getCoupling.drawFromx - 20;
                        getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.125;
                        getCoupling.drawBx = getCoupling.drawTox + 20;
                        getCoupling.drawBy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.375;
                        getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                        getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
                    }
                    else
                    {
                        getCoupling.drawAx = getCoupling.drawFromx - 20;
                        getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
                        getCoupling.drawBx = getCoupling.drawTox + 20;
                        getCoupling.drawBy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
                        getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                        getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
                    }
                }
            }
        }
        else if (getCoupling.toType == "R")
        { //does a fn1 output connect with a fn2 Resource
            if (getCoupling.drawFromx > getCoupling.drawTox - 10)
            {
                if (getCoupling.drawFromy > getCoupling.drawToy - 20)
                {
                    getCoupling.drawAx = getCoupling.drawFromx;
                    getCoupling.drawAy = getCoupling.drawFromy + 20;
                    getCoupling.drawBx = getCoupling.drawTox + 20;
                    getCoupling.drawBy = getCoupling.drawFromy + 20;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                    getCoupling.drawInty = getCoupling.drawFromy + 20;
                }
                else
                {
                    getCoupling.drawAx = getCoupling.drawFromx;
                    getCoupling.drawAy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                    getCoupling.drawBx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5;
                    getCoupling.drawBy = getCoupling.drawToy;
                    getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.25;
                    getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.75;
                }
            }
            else
            {
                getCoupling.drawAx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.5 + 20;
                getCoupling.drawAy = getCoupling.drawFromy;
                getCoupling.drawBx = getCoupling.drawTox + 20;
                getCoupling.drawBy = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.5;
                getCoupling.drawIntx = getCoupling.drawFromx + (getCoupling.drawTox - getCoupling.drawFromx) * 0.75 + 20;
                getCoupling.drawInty = getCoupling.drawFromy + (getCoupling.drawToy - getCoupling.drawFromy) * 0.25;
            }
        }
        
        string[] curve2 = new string[13] {
            "M", getCoupling.drawFromx.ToString("#.##"), getCoupling.drawFromy.ToString("#.##"),
            "Q", getCoupling.drawAx.ToString("#.##"), getCoupling.drawAy.ToString("#.##"), getCoupling.drawIntx.ToString("#.##"), getCoupling.drawInty.ToString("#.##"),
            "Q", getCoupling.drawBx.ToString("#.##"), getCoupling.drawBy.ToString("#.##"), getCoupling.drawTox.ToString("#.##"), getCoupling.drawToy.ToString("#.##")
        };
        return string.Join(" ", curve2);
    }
}
